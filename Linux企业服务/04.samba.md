# samba简介

SMB：Server Message Block服务器消息块，IBM发布，最早是DOS网络文件共享协议

CIFS：common internet file system，微软基于SMB发布

SAMBA：1991年Andrew Tridgell,实现windows和UNIX相通

SAMBA的功能：

* 共享文件和打印，实现在线编辑
* 实现登录SAMBA用户的身份认证
* 可以进行NetBIOS名称解析
* 外围设备共享

Windows计算机网络管理模式：

* 工作组WORKGROUP：计算机对等关系，帐号信息各自管理
* 域DOMAIN：C/S结构，帐号信息集中管理，DC,AD

# 软件介绍

## 相关包

* `samba` 提供smb服务
* `samba-client` 客户端软件
* `samba-common` 通用软件
* `cifs-utils smb`客户端工具
* `samba-winbind` 和AD相关

## 相关服务进程

smbd 提供smb（cifs）服务 TCP:139,445

nmbd NetBIOS名称解析 UDP:137,138

## 主配置文件

主配置文件：/etc/samba/smb.conf 帮助参看：man smb.conf

语法检查： testparm [-v] [/etc/samba/smb.conf]

# 管理SAMBA用户

* 包：samba-common-tools
* 工具：smbpasswd pdbedit
* 用户数据库：/var/lib/samba/private/passdb.tdb

说明：samba用户须是Linux用户，建议使用/sbin/nologin

* 添加系统用户

```shell
yum -y install samba
yum -y install samba-client
systemctl start smb
systemctl start nmb
[root@localhost ~]# useradd -r -s /sbin/nologin smb1
```

* 把系统账号加入samba账号

```shell
[root@localhost ~]# smbpasswd -a smb1
New SMB password:
Retype new SMB password:
Added user smb1.
[root@localhost ~]# pdbedit -a -u smb1
# 这个是pdbedit工具的使用
```

* 如果已经存在，想修改密码

```shell
[root@localhost ~]# smbpasswd smb1
```

* 想要删除用户和密码

```shell
[root@localhost ~]# smbpasswd -x smb1
[root@localhost ~]# pdbedit -x -u smb1
```

* 查看samba用户列表

```shell
[root@localhost ~]# pdbedit -L -v
```

* 查看samba服务器状态

```shell
[root@localhost ~]# yum install -y samba
[root@localhost ~]# smbstatus
```

# samba服务器配置

samba 配置文件/etc/samba/smb.conf格式 ，使用.ini文件的格式

```shell
[root@localhost ~]# vim /etc/samba/smb.conf
[global] #全局参数。
    workgroup = MYGROUP #工作组名称
    server string = Samba Server Version %v #服务器介绍信息，参数%v为显示SMB版本号
    log file = /var/log/samba/log.%m #定义日志文件的存放位置与名称，参数%m为来访的主机名
    max log size = 50 #定义日志文件的最大容量为50KB
    security = user #安全验证的方式，总共有4种
      #share：来访主机无需验证口令；比较方便，但安全性很差
      #user：需验证来访主机提供的口令后才可以访问；提升了安全性
      #server：使用独立的远程主机验证来访主机提供的口令（集中管理账户）
      #domain：使用域控制器进行身份验证
    passdb backend = tdbsam #定义用户后台的类型，共有3种
      #smbpasswd：使用smbpasswd命令为系统用户设置Samba服务程序的密码
      #tdbsam：创建数据库文件并使用pdbedit命令建立Samba服务程序的用户
      #ldapsam：基于LDAP服务进行账户验证
    load printers = yes #设置在Samba服务启动时是否共享打印机设备
    cups options = raw #打印机的选项
    hosts allow = 172.16. .example.com
      # 配置允许访问的主机，可以写成hosts deny来配置拒绝访问的主机
    max log size=50
      # 日志文件达到50K，将轮循rotate,单位KB
[homes] #共享参数
    comment = Home Directories #描述信息
    valid users = %S, %D%w%S
    browseable = no #指定共享信息是否在“网上邻居”中可见
    writable = yes #定义是否可以执行写入操作，与“read only”相反
[printers] #打印机共享参数
    comment = All Printers
    path = /var/spool/samba #共享文件的实际路径(重要)。
    browseable = no
    guest ok = no #是否所有人可见，等同于"public"参数。
    writable = no
    printable = yes
[print$]    # $符号表示隐藏
	comment = Printer Drivers
	path = /var/lib/samba/drivers
	write list = @printadmin root
	force group = @printadmin
	create mask = 0664
	directory mask = 0775
```

宏定义：

* %m：客户端主机的NetBIOS名
* %M：客户端主机的FQDN
* %H：当前用户家目录路径
* %U：当前用户用户名
* %g：当前用户所属组
* %h：samba服务器的主机名
* %L：samba服务器的NetBIOS名
* %I：客户端主机的IP
* %T：当前日期和时间 %S 可登录的用户名
* %S：可登录的用户名
* %D：当前用户所属域或工作组名称
* %w：系统分隔符

# 配置特定目录共享

每个共享目录应该有独立的[ ]部分

* [共享名称]
  * 远程网络看到的共享名称 #真正被共享的名称有Path指定
* comment
  * 注释信息
* path
  * 所共享的目录路径
* public
  * 能否被guest访问的共享，默认no，和guest ok 类似 #默认不允许匿名访问
* browsable
  * 是否允许所有用户浏览此共享,默认为yes,no为隐藏
* writable=yes
  * 可以被所有用户读写，默认为no #打开之后还需要把文件夹的权限开放
  * 对smb虚拟账户授权：setfacl -m u:smbuser：rwx /path/share 这样就可以上传了
  * 当然也可以 chomd 777 /path/share 最大权限 文件系统级别不控制 在smb级别控制即可
* read only=no
  * 和writable=yes等价，如与以上设置冲突，放在后面的设置生效，默认只读
* write list 用户，@组名，+组名,用，分隔，如writable=no，列表中用户或组可读写，不在列表中用户只读
* valid users 特定用户才能访问该共享，如为空，将允许所有用户，用户名之间用空格分隔

范例：基于特定用户和组的共享

```shell
[root@localhost ~]# vim /etc/samba/smb.conf
#最后追加
[share]
path = /app/dir
vaild user=smb1,@smb1
writeable = no
browseable = yes
[root@localhost ~]# mkdir -p /app/dir
[root@localhost dir]# systemctl stop firewalld
[root@localhost dir]# setenforce 0
[root@localhost ~]# systemctl restart smb
```

![image-20220717212038214](04.samba/image-20220717212038214.png)

```
没有写权限
[root@localhost ~]# vim /etc/samba/smb.conf
[share]
path = /app/dir
vaild user=smb1,@smb1
writeable = yes
browseable = yes
[root@localhost ~]# systemctl restart smb
[root@localhost dir]# chmod o+w /app/dir
```



客户端工具：smbclient，mount.cifs

```shell
yum -y install samba
yum -y install samba-client
systemctl start smb
systemctl start nmb
```

# SAMBA客户端工具

UNC路径: Universal Naming Convention,通用命名规范，格式如下

```plain
\\sambaserver\sharename     #中间为samba服务器名或者ip地址
```

使用smbclient 访问SAMBA服务器

```shell
smbclient -L instructor.example.com
smbclient -L instructor.example.com -U smb用户

smbclient //192.168.112.132/share -U smb1
#可以使用-U选项来指定用户%密码，或通过设置和导出USER和PASSWD环境变量来指定
smbclient //instructor.example.com/shared -U user
>cd directory
>get file1 /root/file
>get 1.txt /root/1.txt
>put file2
>put 相对路径
```

挂载CIFS文件系统
范例：手动挂载

```shell
yum -y install cifs-utils
mkdir /mnt/smb1
mount -o user=smb1,password=123 //192.168.175.10/share /mnt/smb

[root@localhost ~]# mount -o user=smb1,password=123 //192.168.175.19/share /mnt/smb
[root@localhost ~]# df -h
```

范例：开机自动挂载

```shell
[root@localhost ~]# cat /etc/fstab
//server/homes /mnt cifs defaults,username='username',password='your password' 0 0

[root@localhost ~]# cat /etc/fstab
//192.168.175.19/share /mnt/smb cifs defaults,username=smb1,password=123 0 0
```

# 案例：通过用户名共享文件

共享销售部`/xsb`这个目录，只有知道用户名和密码的同时可以看这个共享，在/xsb目录中存放销售部重要的数据。需要将security设置为user级别，这样可以启用samba身份验证机制，然后在共享目录`/xsb`下设置valid user 字段，配置只允许销售部员工能访问这个共享目录

* 修改主配置文件安全相关设置

```shell
[root@server1 ~]# vim /etc/samba/smb.conf
[global]
        workgroup = SAMBA
        security = user
#       passdb backend = tdbsam
        passdb backend = smbpasswd
        smb passwd file = /etc/samba/smbpasswd
        printing = cups
        printcap name = cups
        load printers = yes
        cups options = raw
# 重启smb服务之后，会自动生成/etc/samba/smbpasswd该文件
[root@server1 ~]# systemctl restart smb
[root@server1 ~]# ll /etc/samba/smbpasswd
-rw-------. 1 root root 0 7月  17 21:54 /etc/samba/smbpasswd
```

* 添加销售部用户和组

```shell
[root@server1 ~]# groupadd xsb
[root@server1 ~]# useradd -g xsb -M -s /sbin/nologin xsb01
[root@server1 ~]# useradd -g xsb -M -s /sbin/nologin xsb02
[root@server1 ~]# useradd jsb01
```

* 添加相应的samba账户

```shell
[root@server1 ~]# smbpasswd -a xsb01
New SMB password:
Retype new SMB password:
Added user xsb01.
[root@server1 ~]# smbpasswd -a xsb02
New SMB password:
Retype new SMB password:
Added user xsb02.
```

* 指定共享目录

```shell
[root@server1 ~]# mkdir /xsb
[root@server1 ~]# cp /etc/hosts /xsb
[root@server1 ~]# vim /etc/samba/smb.conf
[xsb]
comment = 销售部重要文件
path = /xsb
valid user = xsb01 xsb02
#valid user = xsb01，@xsb
```

* 重启服务

```shell
[root@server1 ~]# systemctl restart smb.service 
[root@server1 ~]# systemctl restart nmb.service
```

* 检查139和445端口号

```shell
[root@server1 ~]# ss -tanl
State       Recv-Q Send-Q  Local Address:Port                 Peer Address:Port              
LISTEN      0      50                  *:139                             *:*                  
LISTEN      0      50                  *:445                             *:*                  
LISTEN      0      50                 :::139                            :::*                  
LISTEN      0      50                 :::445                            :::*
```

在`ss`命令的输出中，`Recv-Q`和`Send-Q`是与TCP连接相关的两个队列的大小。

- `Recv-Q`表示接收队列的大小。它指示了尚未被应用程序（进程）接收的来自网络的数据的数量。当接收队列的大小超过一定限制时，可能会发生数据丢失。
- `Send-Q`表示发送队列的大小。它指示了应用程序（进程）等待发送到网络的数据的数量。当发送队列的大小超过一定限制时，可能会导致发送缓冲区已满，从而阻塞应用程序发送更多的数据。



* 客户端验证

```shell
# linux上验证
[root@server2 ~]# yum install samba-client -y
[root@server2 ~]# smbclient -L //192.168.80.151/xsb -U xsb01
Enter SAMBA\xsb01's password: 
    Sharename       Type      Comment
    ---------       ----      -------
    print$          Disk      Printer Drivers
    xsb             Disk      Xsb Data
    IPC$            IPC       IPC Service (Samba 4.10.16)
    xsb01           Disk      Home Directories
Reconnecting with SMB1 for workgroup listing.
    Server               Comment
    ---------            -------
    Workgroup            Master
    ---------            -------
    SAMBA                SERVER1
# 在windows上进行验证
    windows验证：
    在Window运行输入地址：\\192.168.10.10
    用户名：******
    密码：******
    可以在DOS窗口中使用命令net use * /delete 清空用户缓存信息
    
    
# 别的部门需要先检查秘钥文件
```

* 在Linux上进行挂载

```shell
[root@server2 ~]# mkdir /xsbdata
[root@server2 ~]# yum install cifs-utils -y
[root@server2 ~]# vim auth.smb
username=xsb01
password=1
[root@server2 ~]# vim /etc/fstab
//192.168.175.19/xsb /xsbdata cifs defaults,credentials=/root/auth.smb 0 0
[root@server2 ~]# mount -a
[root@server2 ~]# df -h
[root@server2 ~]# ls /xsbdata/
hosts
```

# 案例：不同账户访问不同目录

```shell
#创建三个samba用户,并指定密码为centos
useradd -s /sbin/nologin -r smb1   #加选项-r 不创建家目录
useradd -s /sbin/nologin -r smb2
useradd -s /sbin/nologin -r smb3
smbpasswd -a smb1       #创建对应账号的口令  ，不加-a表示修改已经存在的账号的口令
smbpasswd -a smb2
smbpasswd -a smb3
[root@SMB ~]#pdbedit -L    #查看samba账号
smb1:995:
smb3:993:
smb2:994:
#修改samba配置文件
vim /etc/samba/smb.conf
#在[global]的workgroup下加一行 
config file= /etc/samba/conf.d/%U 说明：%U表示用户名  #这个步骤为关键步骤
[share]               #共享文件夹在最后添加
	Path=/data/dir        #指定分享文件夹的路径
	writeable = yes
	browseable = yes       
	Guest ok=yes        #是否所有人可见，等同于"public"参数。
[root@SMB ~]# mkdir -p /data/dir
[root@SMB ~]# mkdir -p /data/dir1
[root@SMB ~]# mkdir -p /data/dir2
[root@SMB ~]# touch /data/dir/share.txt  #新建共享文件
[root@SMB ~]# touch /data/dir1/smb1.txt  #新建给smb1用户访问特定文件
[root@SMB ~]# touch /data/dir2/smb2.txt  #新建给smb2用户访问特定文件
[root@SMB ~]# tree /data/
/data/
├── dir
│   └── share.txt
├── dir1
│   └── smb1.txt
└── dir2
    └── smb2.txt
    
3 directories, 3 files
#针对smb1和smb2用户创建单独的配置文件
[root@SMB ~]# mkdir /etc/samba/conf.d/ -pv
[root@SMB ~]# vim /etc/samba/conf.d/smb1
[share]
Path=/data/dir1
Read only= NO #等价于writable = yes
Create mask=0644
#说明：默认为744
[root@SMB ~]# vim /etc/samba/conf.d/smb2
[share]
path=/data/dir2
[root@SMB ~]# systemctl restart smb nmb    #重启对应的服务
# 如果失败，将多余缩进删除
cat -A /etc/samba/smb.conf

#用户smb1，smb2,smb3访问share共享目录，看到目录是不同目录，smb3访问的是默认的share目录
```

* 在客户机上进行测试

```shell
[root@client ~]#smbclient //192.168.32.18/share -U smb1%centos
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Fri Dec 20 13:11:40 2019
  ..                                  D        0  Fri Dec 20 13:10:56 2019
  smb1.txt                            N        0  Fri Dec 20 13:11:40 2019
		52403200 blocks of size 1024. 52004560 blocks available
smb: \> exit
[root@client ~]#smbclient //192.168.32.18/share -U smb2%centos
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Fri Dec 20 13:12:53 2019
  ..                                  D        0  Fri Dec 20 13:10:56 2019
  smb2.txt                            N        0  Fri Dec 20 13:12:53 2019
		52403200 blocks of size 1024. 52004560 blocks available
smb: \> exit
[root@client ~]#smbclient //192.168.32.18/share -U smb3%centos
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Fri Dec 20 13:13:12 2019
  ..                                  D        0  Fri Dec 20 13:10:56 2019
  share.txt                           N        0  Fri Dec 20 13:11:26 2019
		52403200 blocks of size 1024. 52004560 blocks available
smb: \> exit
[root@client ~]#
```

