# daemon 与服务

在 Linux 系统中，**服务（service）** 本质上是由程序提供的功能或能力，例如网络访问、进程调度或负载均衡等。

在类 Unix 系统的相关文档中，常常可以看到 “请启动某某 daemon 以提供某某功能” 这样的描述。那么，**daemon 与 service 之间的关系**是什么？

从定义上来看：

- **Service** 指代操作系统对外或对内提供的功能（例如 Web 服务、SSH 服务等）；
- **Daemon** 指在后台运行、支撑某一服务的进程（例如 nginx 进程作为守护进程，提供 HTTP/负载均衡服务）。

换句话说，**服务依赖于守护进程的运行**。如果没有对应的 daemon 进程在后台执行，该服务也无法被提供。

例如：

- “Nginx 服务” 是系统提供的一项功能；
- “nginx 守护进程” 是实现该服务的后台程序。

在 Linux 系统启动后，无论是命令行模式（runlevel 3）还是图形界面模式（runlevel 5），系统都会自动启动并运行多个服务（例如 `sshd`）。

## Linux 服务管理的演进

在早期 Linux 系统中，服务管理采用 **System V init（SysV init）** 机制。系统启动时，内核会启动第一个用户空间进程 **`init`**，由它依次加载并启动各类服务。SysV init 通过脚本的方式对服务进行管理，例如：

```
启动：/etc/init.d/daemon start
关闭：/etc/init.d/daemon stop
重启：/etc/init.d/daemon restart
状态查看：/etc/init.d/daemon status
```

从 CentOS 7 开始，Linux 发行版逐步弃用了 SysV init，转而采用 **systemd** 作为新的服务管理机制。`systemd` 相较于传统的 SysV init，具有启动速度快、并行化管理、统一日志处理等优势。

# systemd 简介

Systemd 是 Linux 系统中最新的初始化系统（init），它主要的设计目标是克服 sysvinit（这个是centos6中的初始化系统）固有的缺点，提高系统的启动速度。

Linux内核加载启动后，用户空间的第一个进程就是初始化进程，这个程序的物理文件约定位于`/sbin/init`，当然也可以通过传递内核参数来让内核启动指定的程序。这个进程的特点是进程号为1，代表第一个运行的用户空间进程。不同发行版采用了不同的启动程序，主要有以下几种主流选择：

* 以 Ubuntu 为代表的 Linux 发行版采用 upstart
* 红帽系列发行版本中
  - 红帽6以前的版本使用System V init
  - 红帽7及以后，使用systemd

RockyLinux上所有的进程都是systemd的后代，systemd的功能繁多，不仅用来管理服务，还可以管理挂载点，定义定时任务等。这些工作都是由编辑相应的配置单元文件完成的。

## systemd unit 类型

systemd需要管理的功能比较多，所以支持的配置单元类型也比较繁多，我们在日常使用Linux的过程中对系统服务的管理最多，所以我们主要了解一下`service`类型即可，其他类型作为一个了解，下面列举出所有类型详细的解释。

| **单元类型**   | **文件格式** | **描述**                                                     |
| :------------- | :----------- | :----------------------------------------------------------- |
| Service unit   | .service     | 服务类                                                       |
| Target unit    | .target      | 一个 unit 服务组，用于模拟实现运行级别                       |
| Automount unit | .automount   | 文件系统自动挂载点                                           |
| Device unit    | .device      | 内核识别的设备文件                                           |
| Mount unit     | .mount       | 文件系统挂载点                                               |
| Path unit      | .path        | 文件或目录                                                   |
| Scope unit     | .scope       | 外部创建的进程                                               |
| Slice unit     | .slice       | A group of hierarchically organized units that manage system processes. |
| Snapshot unit  | .snapshot    | 系统快照                                                     |
| Socket unit    | .socket      | 套接字                                                       |
| Swap unit      | .swap        | 标识 swap 设备                                               |
| Timer unit     | .timer       | systemd 的计时器                                             |

## unit 文件保存位置

我们目前了解到文件所在的位置即可，关于文件内部的格式与如何修改这些文件，我们会在后续的服务搭建过程中细讲。

| **目录**                 | **描述**                          |
| :----------------------- | :-------------------------------- |
| /usr/lib/systemd/system/ | RPM 包安装时分发的 unit 文件      |
| /run/systemd/system/     | systemd 运行时创建的文件          |
| /etc/systemd/system/     | systemctl enable 创建的 unit 文件 |

# 管理系统服务

systemd 来管理服务的方式是通过 systemctl 命令，相较于 SysV 通过 service / chkconfig / setup / init 一堆命令，systemd 管理服务的方式简单多了。

```shell
[root@localhost ~]# systemctl [command] [unit]
command 主要有：
start： 启动该服务
stop： 停止该服务
restart： 重启该服务
reload： 重启该服务的启动脚本（即 /usr/lib/systemd/system/ 下的文件）
enable： 设置开机自启动
disable： 关闭开机自启动
status： 查看该服务的状态
is-active： 查看该服务目前有没有启动
is-enable：查看该服务有没有设置开机自启动
```

## systemctl 常用命令

这边列举出来的命令会在后面的学习过程中经常用到，所以大家只要对本部分中系统管理的命令合集有一个影响即可。

| **命令**                                                     | **描述**                               |
| :----------------------------------------------------------- | :------------------------------------- |
| systemctl start name.service                                 | 启动服务                               |
| systemctl stop name.service                                  | 停止服务                               |
| systemctl restart name.service                               | 重启服务（没启动的服务会启动）         |
| systemctl try-restart name.service                           | 只重启正在运行的服务                   |
| systemctl reload name.service                                | 重载配置文件                           |
| systemctl status name.service systemctl is-active name.service | 检查服务状态检查服务是否启动           |
| systemctl list-units --type service --all                    | 显示所有的服务状态                     |
| systemctl enable name.service                                | 启用开机自启服务                       |
| systemctl disable name.service                               | 停用自启服务                           |
| systemctl status name.service systemctl is-enabled name.service | 检查服务状态查看服务是否自启           |
| systemctl list-unit-files --type service                     | 查看所有服务                           |
| systemctl list-dependencies --after                          | 列出在指定服务之前启动的服务（依赖）   |
| systemctl list-dependencies --before                         | 列出在指定服务之后启动的服务（被依赖） |

## **服务状态**

```bash
[root@localhost ~]# systemctl status nginx.service 
● nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; static; vendor preset: disabled)
   Active: active (running) since 四 2023-03-30 08:42:37 CST; 1 weeks 1 days ago
```

- 服务的当前状态：
  - active (running)：表示服务正在运行
  - active (exited)：表示该服务执行一次就正常结束，目前没有执行
  - active (waiting)：表示该服务正在运行，不要需要等待其他事件执行之后才能继续处理
  - inactive：表示服务目前关闭，没有运行
- 服务预设状态：
  - enable：开机的时候将自启动
  - disable：开机的时候不会自启动
  - static：这个服务不会开机自启动，但是有可能会被其他开机自启动的服务来唤醒（依赖性）
  - mask：无论如何都不会被启动，因为已经被强制注销

## 服务启动文件

前面我们说过，服务的启动脚本文件放在  `/usr/lib/systemd/system/`下的，如果需要对服务的启动脚本文件修改，需要进入到该目录下（官方不建议直接修改该目录下的文件，但是会比较麻烦且繁琐）

拿 sshd.service 举例，来了解下服务的启动脚本里面的配置字段

```bash
[root@minion2 ~]# cat /usr/lib/systemd/system/sshd.service   
[Unit]
Description=OpenSSH server daemon
Documentation=man:sshd(8) man:sshd_config(5)
After=network.target sshd-keygen.service
Wants=sshd-keygen.service

[Service]
Type=notify
EnvironmentFile=/etc/sysconfig/sshd
ExecStart=/usr/sbin/sshd -D $OPTIONS
ExecReload=/bin/kill -HUP $MAINPID
KillMode=process
Restart=on-failure
RestartSec=42s

[Install]
WantedBy=multi-user.target
```

分析上面文件中的内容，我们可以看到分成了三个部分（block）：

- \[Unit\]：用于描述服务的元信息和依赖关系。
  - `Description`：给出当前服务的简单描述
  - `Documentation`：文档位置
  - `After`：服务必须在 `network.target` 和 `sshd-keygen.service` 之后启动。
  - `Wants`：表示 `sshd.service` 希望（但不是强制）依赖 `sshd-keygen.service`。`Wants` 是一种弱依赖，如果 `sshd-keygen.service` 启动失败，`sshd` 仍然可以运行。
- [Service]：定义服务的具体行为和运行方式。
  - `Type`：服务启动类型。`notify` 表示服务会在启动完成后主动向 systemd 发送通知，表明自己已经就绪。
  - `EnvironmentFile`：指定一个环境变量文件，用于给服务加载额外的启动参数（例如 `$OPTIONS`）。
  - `ExecStart`：定义启动服务时执行的命令。
  - `ExecReload`：定义重载配置时执行的命令。
  - `KillMode`：定义停止服务时的杀进程模式。`process` 表示只杀死主进程，不会杀掉它可能派生的子进程。
  - `Restart`：指定在服务异常退出时是否重启。`on-failure` 表示仅在非零退出码或信号导致的失败时才重启。
  - `RestartSec`：定义服务重启前的等待时间
- [Install]：定义服务在启用（enable）时与 target 的关联。
  - 这部分与 `systemctl enable` 或  `systemctl disable` 命令相结合，用于 enable 或 disable 一个服务
  - `WantedBy`：定义服务如何被启用（enable）时链接到相应的 target。表示当系统进入 `multi-user.target` 运行级别（类似 SysV 的 runlevel 3，带网络和多用户环境）时，此服务会自动启动。



