# 实验环境
## 登录方式
1. 打开WMware选项[文件] -> [连接服务器]
2. 输入信息如下: 
```shell
服务器名称 10.3.33.233
用户名 teamX@vsphere.local
    - X: 01-13
密码 !QAZ2wsx
虚拟机用户 root
虚拟机密码 1
备注 ☑️总是信任具有此证书的主机
```
## 环境介绍
```shell
team01
    master01 10.3.201.100
    node01 10.3.201.101
    node02 10.3.201.102
team02 
    master01 10.3.202.100
    node01 10.3.202.101
    node02 10.3.202.102
......
team13 
    master01 10.3.213.100
    node01 10.3.213.101
    node02 10.3.213.102

每个team中master01节点为本集群的NFS服务端 
```
# 故障排查和业务需求
## 1.K8s集群异常
前置条件: IP冲突，需要将IP修改为组编号
异常现象: `kubectl get nodes -o wide`INTERNAL-IP字段变化

### 主节点
- 更新Kubernets核心配置
```shell
sed  -i 's/10.3.201/10.3.203/g' /etc/kubernetes/manifests/etcd.yaml
sed  -i 's/10.3.201/10.3.203/g' /etc/kubernetes/manifests/kube-apiserver.yaml

sed  -i 's/10.3.201/10.3.203/g' /etc/kubernetes/admin.conf
sed  -i 's/10.3.201/10.3.203/g' /etc/kubernetes/controller-manager.conf
sed  -i 's/10.3.201/10.3.203/g' /etc/kubernetes/kubelet.conf
sed  -i 's/10.3.201/10.3.203/g' /etc/kubernetes/scheduler.conf
sed  -i 's/10.3.201/10.3.203/g' /etc/kubernetes/super-admin.conf
sed  -i 's/10.3.201/10.3.203/g' $HOME/.kube/config

# 更新cluster-info CM: 将旧IP改为新IP
kubectl -n kube-public edit cm cluster-info
# 更新kube-proxy CM: 将旧IP改为新IP
kubectl -n kube-system edit cm kube-proxy

```
- 重新生成证书
```shell
[root@master01 ~]# cat kubeadm-conf.yaml
# 10.0.0.1加入SANs中
apiVersion: kubeadm.k8s.io/v1beta3
kind: ClusterConfiguration
apiServer:
  certSANs:
    - "10.3.203.100"
    - "10.0.0.1"

mv /etc/kubernetes/pki/apiserver.{key,crt} backup/
# mv /etc/kubernetes/pki/front-proxy-client.{key,crt} backup/
kubeadm init phase certs apiserver --config kubeadm-conf.yaml
# kubeadm init phase certs front-proxy-client
```
- 重启服务
```shell
systemctl restart docker kubelet
```
- 获取加入命令
```shell
[root@master01 ~]# kubeadm token create --print-join-command
kubeadm join 10.3.203.100:6443 --token we18lx.eieoh8pl249fikhn --discovery-token-ca-cert-hash sha256:9e2991ca808a6559040fceedad3aa30e15500dd7a02668d146b002c3fddef3fa
```
- 驱除节点
```shell
kubectl drain node01 --ignore-daemonsets --delete-emptydir-data
```
### 工作节点
**方式1**
```shell
sed  -i 's/10.3.201/10.3.203/g' /etc/kubernetes/kubelet.conf
systemctl restart kubelet
```
**方式2**
- 驱除节点
- 重置节点配置
```shell
kubeadm reset -f --cri-socket ///var/run/cri-dockerd.sock

rm -rf /etc/kubernetes /var/lib/kubelet
rm -rf /etc/kubernetes/
rm -rf /var/lib/kubelet/
rm -rf $HOME/.kube/config
rm -rf /etc/cni/net.d/ && rm -rf /var/lib/cni/

iptables -F && iptables -t nat -F && iptables -t mangle -F && iptables -X

ip route flush proto bird
```
- 重新加入集群
```shell
kubeadm join 10.3.203.100:6443 --token <token> --discovery-token-ca-cert-hash <ca> --cri-socket unix:///var/run/cri-dockerd.sock
```
## 2.正常访问LNMP服务
- 将`/root/resources/01.nginx.yaml,02.phpfpm.yaml`等文件中NFS地址指向本集群master01
- 为`nginx.yaml,phpfpm.yaml`等文件添加健康检查机制
- 检查`nginx php-fpm mysql`服务
- 通过`curl -v http://bbs.iproute.cn`访问正常
- 修改`service/ingress-nginx-controller`为`NodePort`方式并通过`helm`更新

## 3.MySQL密码修改
- 新密码为:`123456`
- 通过`curl -v http://bbs.iproute.cn`访问正常
```shell
kubectl exec -it mysql-776786446d-bjcnn -- /bin/bash
mysql -uroot -p123
ALTER USER 'root'@'localhost' IDENTIFIED BY '123456';
ALTER USER 'root'@'%' IDENTIFIED BY '123456';
FLUSH PRIVILEGES;

# 日志文件
/usr/share/nginx/html/data/log/

[root@master01 resources]# grep -nrw '123456' /root/data/nfs/html/*
/root/data/nfs/html/config/config_global.php:9:$_config['db'][1]['dbpw'] = '123456';
/root/data/nfs/html/uc_server/data/config.inc.php:4:define('UC_DBPW', '123456');
```
## 4.Redis持久化
- 配置文件通过configmap挂载至`/usr/local/etc/redis/redis.conf`
- 数据目录通过nfs挂载至`/data`
- 测试验证
```shell
# 进入容器写入测试数据
kubectl exec -it $(kubectl get pods -l app=redis -o jsonpath='{.items[0].metadata.name}') -- redis-cli
> SET testkey "persistence_verified"
> SAVE
# 文件持久化
[root@master01 ~]# tree data/nfs/redis/
data/nfs/redis/
└── data
    ├── appendonlydir
    │   ├── appendonly.aof.1.base.rdb
    │   ├── appendonly.aof.1.incr.aof
    │   └── appendonly.aof.manifest
    └── dump.rdb

# 删除 Pod 触发重建后验证数据
kubectl delete pod $(kubectl get pods -l app=redis -o jsonpath='{.items[0].metadata.name}')
[root@master01 resources]# kubectl exec $(kubectl get pods -l app=redis -o jsonpath='{.items[0].metadata.name}') -- redis-cli GET testkey
persistence_verified
```

## 5.新增工作节点
- 前置条件: 参考`03.安装手册`
**工作节点**
```shell
kubeadm join 10.3.203.100:6443 --token <token> --discovery-token-ca-cert-hash <ca> --cri-socket unix:///var/run/cri-dockerd.sock
```

## 6.配置HPA
- 给`nginx php`配置HPA
- 压测并测试验证
```shell
# 提供YAML文件

# 压测
yum install httpd-tools -y
ab -n 10000 -c 10 http://bbs.iproute.cn/

## 观察
watch kubectl top -l app=php
Every 2.0s: kubectl get hpa                                                  master01: Fri Apr 11 11:11:48 2025
NAME	  REFERENCE        TARGETS            MINPODS   MAXPODS   REPLICAS   AGE
php-hpa   Deployment/php   211%/80%, 9%/80%   3         10 	  5          3m37s
# 查看
kubectl top
```

## 7.MySQL高可用-主从
- 测试验证主从服务可用
- 将旧数据库里的数据导入至新数据库
- 将业务切到新数据库并实现读写分离
- [扩展] 数据完整性和一致性怎么校验?
- [扩展] 如何设计方案无损迁移?
- [扩展] 如何实现水平扩容？
```shell
mkdir -pv /root/data/nfs/mysql-{master,slave}/{data,conf,log}
rsync -avh /root/data/nfs/mysql/data/ /root/data/nfs/mysql-master/data
```

## 8.Redis哨兵

# 相关命令
```shell
# 通过 API 生成临时 Token（有效期 1 小时）
kubectl create token calico-node -n kube-system --duration=1h

# 检查 Token 有效性
curl -k -H "Authorization: Bearer <TOKEN>" https://<API-SERVER>:6443/api/v1/namespaces/kube-system/pods

# 恢复调度
kubectl uncordon node01

# 查看crt文件SAN地址
openssl x509 -in /etc/kubernetes/pki/apiserver.crt -text | grep -A 1 'X509v3 Subject Alternative Name'

# 升级chart
helm upgrade ingress-nginx ./ingress-nginx -n ingress --values ./ingress-nginx/values.yaml

# 清理缓存
sudo killall -HUP mDNSResponder

# 配置主从复制
stop slave;
change master to master_host='mysql-master',master_user='replicator',master_password='replicator123',master_log_file='mysql-bin.000001',master_log_pos=1786;
start slave;

# 清除所有复制配置（包括master.info文件）
reset slave all; 

# 访问业务
[root@master01 resources]# curl -H "host: bbs.iproute.cn" 10.3.202.101:`kubectl get svc/ingress-nginx-controller -n ingress-nginx -o jsonpath="{.spec.ports[?(@.port==80)].nodePort}" -n ingress`

# calicoctl相关命令
[root@master01 ~]# ./calicoctl-linux-amd64 node status
Calico process is running.

IPv4 BGP status
+--------------+-------------------+-------+----------+-------------+
| PEER ADDRESS |     PEER TYPE     | STATE |  SINCE   |    INFO     |
+--------------+-------------------+-------+----------+-------------+
| 10.3.204.101 | node-to-node mesh | up    | 05:11:14 | Established |
| 10.3.204.102 | node-to-node mesh | up    | 05:12:46 | Established |
+--------------+-------------------+-------+----------+-------------+

[root@master01 ~]# ./calicoctl-linux-amd64 get ipPool --allow-version-mismatch -o wide
NAME                  CIDR            NAT    IPIPMODE   VXLANMODE   DISABLED   SELECTOR
default-ipv4-ippool   10.244.0.0/16   true   Never      Never       false      all()

[root@master01 ~]# calicoctl ipam show --show-blocks --allow-version-mismatch

[root@master01 ~]# calicoctl ipam show --allow-version-mismatch
+----------+---------------+-----------+------------+-------------+
| GROUPING |     CIDR      | IPS TOTAL | IPS IN USE |  IPS FREE   |
+----------+---------------+-----------+------------+-------------+
| IP Pool  | 10.244.0.0/16 |     65536 | 2294 (4%)  | 63242 (96%) |
+----------+---------------+-----------+------------+-------------+
```
